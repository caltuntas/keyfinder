#include "test-framework/unity.h"
#include "keyfinder.h"
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#define ARRAY_LEN(arr) (sizeof(arr)/sizeof(arr[0]))

void setUp(void)
{
}

void tearDown(void)
{
}

static uintptr_t ptr = 0x555ee368e000;
static void test_find_aes_128_expanded_keys_at_aligned_offset(void)
{
  uint8_t buffer[BUFFER_SIZE]={0};
  uint8_t expected_key[16]={0x2b,0x7e,0x15,0x16,0x28,0xae,0xd2,0xa6,0xab,0xf7,0x15,0x88,0x09,0xcf,0x4f,0x3c};
  uint8_t round_keys[176] = {
    0x2b,0x7e,0x15,0x16,0x28,0xae,0xd2,0xa6,0xab,0xf7,0x15,0x88,0x09,0xcf,0x4f,0x3c,
    0xa0,0xfa,0xfe,0x17,0x88,0x54,0x2c,0xb1,0x23,0xa3,0x39,0x39,0x2a,0x6c,0x76,0x05,
    0xf2,0xc2,0x95,0xf2,0x7a,0x96,0xb9,0x43,0x59,0x35,0x80,0x7a,0x73,0x59,0xf6,0x7f,
    0x3d,0x80,0x47,0x7d,0x47,0x16,0xfe,0x3e,0x1e,0x23,0x7e,0x44,0x6d,0x7a,0x88,0x3b,
    0xef,0x44,0xa5,0x41,0xa8,0x52,0x5b,0x7f,0xb6,0x71,0x25,0x3b,0xdb,0x0b,0xad,0x00,
    0xd4,0xd1,0xc6,0xf8,0x7c,0x83,0x9d,0x87,0xca,0xf2,0xb8,0xbc,0x11,0xf9,0x15,0xbc,
    0x6d,0x88,0xa3,0x7a,0x11,0x0b,0x3e,0xfd,0xdb,0xf9,0x86,0x41,0xca,0x00,0x93,0xfd,
    0x4e,0x54,0xf7,0x0e,0x5f,0x5f,0xc9,0xf3,0x84,0xa6,0x4f,0xb2,0x4e,0xa6,0xdc,0x4f,
    0xea,0xd2,0x73,0x21,0xb5,0x8d,0xba,0xd2,0x31,0x2b,0xf5,0x60,0x7f,0x8d,0x29,0x2f,
    0xac,0x77,0x66,0xf3,0x19,0xfa,0xdc,0x21,0x28,0xd1,0x29,0x41,0x57,0x5c,0x00,0x6e,
    0xd0,0x14,0xf9,0xa8,0xc9,0xee,0x25,0x89,0xe1,0x3f,0x0c,0xc8,0xb6,0x63,0x0c,0xa6,
  };
  int key_start_offset = 1024;
  int expanded_keys_size = sizeof(round_keys);
  int remaining_buffer_size = BUFFER_SIZE - (key_start_offset + expanded_keys_size);
  memset(buffer,0xAA,key_start_offset);
  memcpy(buffer+key_start_offset,round_keys,expanded_keys_size);
  memset(buffer+key_start_offset+expanded_keys_size,0x55,remaining_buffer_size);
  aes_128_key_t* res = find_aes_128_keys(buffer,BUFFER_SIZE,ptr);
  TEST_ASSERT_EQUAL_INT(key_start_offset,res->offset);
  TEST_ASSERT_EQUAL_HEX8_ARRAY(expected_key,res->key,16);
}

static void test_find_aes_128_expanded_keys_at_unaligned_offset(void)
{
  uint8_t buffer[BUFFER_SIZE]={0};
  uint8_t expected_key[16]={0x2b,0x7e,0x15,0x16,0x28,0xae,0xd2,0xa6,0xab,0xf7,0x15,0x88,0x09,0xcf,0x4f,0x3c};
  uint8_t round_keys[176] = {
    0x2b,0x7e,0x15,0x16,0x28,0xae,0xd2,0xa6,0xab,0xf7,0x15,0x88,0x09,0xcf,0x4f,0x3c,
    0xa0,0xfa,0xfe,0x17,0x88,0x54,0x2c,0xb1,0x23,0xa3,0x39,0x39,0x2a,0x6c,0x76,0x05,
    0xf2,0xc2,0x95,0xf2,0x7a,0x96,0xb9,0x43,0x59,0x35,0x80,0x7a,0x73,0x59,0xf6,0x7f,
    0x3d,0x80,0x47,0x7d,0x47,0x16,0xfe,0x3e,0x1e,0x23,0x7e,0x44,0x6d,0x7a,0x88,0x3b,
    0xef,0x44,0xa5,0x41,0xa8,0x52,0x5b,0x7f,0xb6,0x71,0x25,0x3b,0xdb,0x0b,0xad,0x00,
    0xd4,0xd1,0xc6,0xf8,0x7c,0x83,0x9d,0x87,0xca,0xf2,0xb8,0xbc,0x11,0xf9,0x15,0xbc,
    0x6d,0x88,0xa3,0x7a,0x11,0x0b,0x3e,0xfd,0xdb,0xf9,0x86,0x41,0xca,0x00,0x93,0xfd,
    0x4e,0x54,0xf7,0x0e,0x5f,0x5f,0xc9,0xf3,0x84,0xa6,0x4f,0xb2,0x4e,0xa6,0xdc,0x4f,
    0xea,0xd2,0x73,0x21,0xb5,0x8d,0xba,0xd2,0x31,0x2b,0xf5,0x60,0x7f,0x8d,0x29,0x2f,
    0xac,0x77,0x66,0xf3,0x19,0xfa,0xdc,0x21,0x28,0xd1,0x29,0x41,0x57,0x5c,0x00,0x6e,
    0xd0,0x14,0xf9,0xa8,0xc9,0xee,0x25,0x89,0xe1,0x3f,0x0c,0xc8,0xb6,0x63,0x0c,0xa6,
  };
	int key_start_offset = 1021;
	int expanded_keys_size = sizeof(round_keys);
	int remaining_buffer_size = BUFFER_SIZE - (key_start_offset + expanded_keys_size);
  memset(buffer,0xAA,key_start_offset);
  memcpy(buffer+key_start_offset,round_keys,expanded_keys_size);
  memset(buffer+key_start_offset+expanded_keys_size,0x55,remaining_buffer_size);
  aes_128_key_t* res = find_aes_128_keys(buffer,BUFFER_SIZE,ptr);
  TEST_ASSERT_EQUAL_INT(key_start_offset,res->offset);
  TEST_ASSERT_EQUAL_HEX8_ARRAY(expected_key,res->key,16);
}

static void test_find_aes_128_expanded_keys_at_the_end(void)
{
  uint8_t buffer[BUFFER_SIZE]={0};
  uint8_t expected_key[16]={0x2b,0x7e,0x15,0x16,0x28,0xae,0xd2,0xa6,0xab,0xf7,0x15,0x88,0x09,0xcf,0x4f,0x3c};
  uint8_t round_keys[176] = {
    0x2b,0x7e,0x15,0x16,0x28,0xae,0xd2,0xa6,0xab,0xf7,0x15,0x88,0x09,0xcf,0x4f,0x3c,
    0xa0,0xfa,0xfe,0x17,0x88,0x54,0x2c,0xb1,0x23,0xa3,0x39,0x39,0x2a,0x6c,0x76,0x05,
    0xf2,0xc2,0x95,0xf2,0x7a,0x96,0xb9,0x43,0x59,0x35,0x80,0x7a,0x73,0x59,0xf6,0x7f,
    0x3d,0x80,0x47,0x7d,0x47,0x16,0xfe,0x3e,0x1e,0x23,0x7e,0x44,0x6d,0x7a,0x88,0x3b,
    0xef,0x44,0xa5,0x41,0xa8,0x52,0x5b,0x7f,0xb6,0x71,0x25,0x3b,0xdb,0x0b,0xad,0x00,
    0xd4,0xd1,0xc6,0xf8,0x7c,0x83,0x9d,0x87,0xca,0xf2,0xb8,0xbc,0x11,0xf9,0x15,0xbc,
    0x6d,0x88,0xa3,0x7a,0x11,0x0b,0x3e,0xfd,0xdb,0xf9,0x86,0x41,0xca,0x00,0x93,0xfd,
    0x4e,0x54,0xf7,0x0e,0x5f,0x5f,0xc9,0xf3,0x84,0xa6,0x4f,0xb2,0x4e,0xa6,0xdc,0x4f,
    0xea,0xd2,0x73,0x21,0xb5,0x8d,0xba,0xd2,0x31,0x2b,0xf5,0x60,0x7f,0x8d,0x29,0x2f,
    0xac,0x77,0x66,0xf3,0x19,0xfa,0xdc,0x21,0x28,0xd1,0x29,0x41,0x57,0x5c,0x00,0x6e,
    0xd0,0x14,0xf9,0xa8,0xc9,0xee,0x25,0x89,0xe1,0x3f,0x0c,0xc8,0xb6,0x63,0x0c,0xa6,
  };
	int key_start_offset = 3920;
	int expanded_keys_size = sizeof(round_keys);
	int remaining_buffer_size = BUFFER_SIZE - (key_start_offset + expanded_keys_size);
  memset(buffer,0xAA,key_start_offset);
  memcpy(buffer+key_start_offset,round_keys,expanded_keys_size);
  memset(buffer+key_start_offset+expanded_keys_size,0x55,remaining_buffer_size);
  aes_128_key_t* res = find_aes_128_keys(buffer,BUFFER_SIZE,ptr);
  TEST_ASSERT_EQUAL_INT(key_start_offset,res->offset);
  TEST_ASSERT_EQUAL_HEX8_ARRAY(expected_key,res->key,16);
}

static void test_find_aes_128_expanded_keys_at_the_beginnig(void)
{
  uint8_t buffer[BUFFER_SIZE]={0};
  uint8_t expected_key[16]={0x2b,0x7e,0x15,0x16,0x28,0xae,0xd2,0xa6,0xab,0xf7,0x15,0x88,0x09,0xcf,0x4f,0x3c};
  uint8_t round_keys[176] = {
    0x2b,0x7e,0x15,0x16,0x28,0xae,0xd2,0xa6,0xab,0xf7,0x15,0x88,0x09,0xcf,0x4f,0x3c,
    0xa0,0xfa,0xfe,0x17,0x88,0x54,0x2c,0xb1,0x23,0xa3,0x39,0x39,0x2a,0x6c,0x76,0x05,
    0xf2,0xc2,0x95,0xf2,0x7a,0x96,0xb9,0x43,0x59,0x35,0x80,0x7a,0x73,0x59,0xf6,0x7f,
    0x3d,0x80,0x47,0x7d,0x47,0x16,0xfe,0x3e,0x1e,0x23,0x7e,0x44,0x6d,0x7a,0x88,0x3b,
    0xef,0x44,0xa5,0x41,0xa8,0x52,0x5b,0x7f,0xb6,0x71,0x25,0x3b,0xdb,0x0b,0xad,0x00,
    0xd4,0xd1,0xc6,0xf8,0x7c,0x83,0x9d,0x87,0xca,0xf2,0xb8,0xbc,0x11,0xf9,0x15,0xbc,
    0x6d,0x88,0xa3,0x7a,0x11,0x0b,0x3e,0xfd,0xdb,0xf9,0x86,0x41,0xca,0x00,0x93,0xfd,
    0x4e,0x54,0xf7,0x0e,0x5f,0x5f,0xc9,0xf3,0x84,0xa6,0x4f,0xb2,0x4e,0xa6,0xdc,0x4f,
    0xea,0xd2,0x73,0x21,0xb5,0x8d,0xba,0xd2,0x31,0x2b,0xf5,0x60,0x7f,0x8d,0x29,0x2f,
    0xac,0x77,0x66,0xf3,0x19,0xfa,0xdc,0x21,0x28,0xd1,0x29,0x41,0x57,0x5c,0x00,0x6e,
    0xd0,0x14,0xf9,0xa8,0xc9,0xee,0x25,0x89,0xe1,0x3f,0x0c,0xc8,0xb6,0x63,0x0c,0xa6,
  };
	int start_offset = 0;
	int expanded_keys_size = sizeof(round_keys);
	int remaining_buffer_size = BUFFER_SIZE - (start_offset + expanded_keys_size);
  memset(buffer,0xAA,start_offset);
  memcpy(buffer+start_offset,round_keys,expanded_keys_size);
  memset(buffer+start_offset+expanded_keys_size,0x55,remaining_buffer_size);
  aes_128_key_t* res = find_aes_128_keys(buffer,BUFFER_SIZE,ptr);
  TEST_ASSERT_EQUAL_INT(start_offset,res->offset);
  TEST_ASSERT_EQUAL_HEX8_ARRAY(expected_key,res->key,16);
}

static void test_find_memory_address_in_buffer(void)
{
  uint8_t buffer[BUFFER_SIZE]={0};
  uint8_t address[8]={0};
  uintptr_t ptr = 0x555ee368e000;
  memcpy(address,&ptr,sizeof(ptr));
  int start_offset = 0;
  int pointer_size = sizeof(address);
  int remaining_buffer_size = BUFFER_SIZE - (start_offset + pointer_size);
  memset(buffer,0xAA,start_offset);
  memcpy(buffer+start_offset,address,pointer_size);
  memset(buffer+start_offset+pointer_size,0x55,remaining_buffer_size);
  uintptr_t res = find_iv_addr(buffer,BUFFER_SIZE,ptr,start_offset);
  TEST_ASSERT_EQUAL_INT(start_offset-0x50,res);
}

int main(void)
{
  UNITY_BEGIN();
  RUN_TEST(test_find_aes_128_expanded_keys_at_aligned_offset);
  RUN_TEST(test_find_aes_128_expanded_keys_at_unaligned_offset);
  RUN_TEST(test_find_aes_128_expanded_keys_at_the_end);
  RUN_TEST(test_find_aes_128_expanded_keys_at_the_beginnig);
  RUN_TEST(test_find_memory_address_in_buffer);
  return UNITY_END();
}
